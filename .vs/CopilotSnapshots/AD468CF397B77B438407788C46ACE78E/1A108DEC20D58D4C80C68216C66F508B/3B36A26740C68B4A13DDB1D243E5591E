using System;
using System.Drawing;
using System.Media;
using System.Windows.Forms;
using flappy_bird_tesst.Properties;

namespace flappy_bird_tesst
{
    public partial class Form1 : Form
    {
        // Game state
        private int gravity = 2;     // Bird falling speed
        private int flapPower = -15; // Upward impulse on flap
        private int pipeSpeed = 5;   // Pipe horizontal speed
        private int score = 0;
        private bool isFlapping = false;
        private bool isPaused = false;
        private bool isGameOver = false;
        private Random rng = new Random();

        // Bird animation
        private Bitmap birdFrameDown;
        private Bitmap birdFrameMid;
        private Bitmap birdFrameUp;
        private int animTick = 0;
        private int animIntervalTicks = 4; // change frame every N ticks
        private int wingFrame = 0; // 0=down,1=mid,2=up

        // Pipe sprites
        private Bitmap pipeSprite;        // bottom pipe image (unflipped)
        private Bitmap pipeTopSprite;     // top pipe image (flipped vertically)

        // Sounds
        private SoundPlayer sWing;
        private SoundPlayer sPoint;
        private SoundPlayer sHit;
        private SoundPlayer sDie;
        private SoundPlayer sSwoosh;

        // Overlays
        private PictureBox overlayMessage;
        private PictureBox overlayGameOver;

        public Form1()
        {
            InitializeComponent();

            // Reduce flicker
            this.SetStyle(ControlStyles.AllPaintingInWmPaint | ControlStyles.OptimizedDoubleBuffer | ControlStyles.UserPaint, true);

            // Prepare resources and UI
            InitializeResources();
            InitializeUiAssets();

            InitializeGame();
        }

        private void InitializeResources()
        {
            // Randomize background (day or night)
            var bg = rng.Next(2) == 0 ? Resources.background_day : Resources.background_night;
            this.BackgroundImage = bg;
            this.BackgroundImageLayout = ImageLayout.Stretch;

            // Randomize bird color set
            int birdSet = rng.Next(3); // 0=yellow,1=blue,2=red
            switch (birdSet)
            {
                case 1:
                    birdFrameDown = Resources.bluebird_downflap;
                    birdFrameMid = Resources.bluebird_midflap;
                    birdFrameUp = Resources.bluebird_upflap;
                    break;
                case 2:
                    birdFrameDown = Resources.redbird_downflap;
                    birdFrameMid = Resources.redbird_midflap;
                    birdFrameUp = Resources.redbird_upflap;
                    break;
                default:
                    birdFrameDown = Resources.yellowbird_downflap;
                    birdFrameMid = Resources.yellowbird_midflap;
                    birdFrameUp = Resources.yellowbird_upflap;
                    break;
            }

            // Prepare sounds
            sWing = new SoundPlayer(Resources.wing);
            sPoint = new SoundPlayer(Resources.point);
            sHit = new SoundPlayer(Resources.hit);
            sDie = new SoundPlayer(Resources.die);
            sSwoosh = new SoundPlayer(Resources.swoosh);

            // Ground texture
            ground.BackgroundImage = Resources._base;
            ground.BackgroundImageLayout = ImageLayout.Tile;

            // PictureBox display modes
            bird.SizeMode = PictureBoxSizeMode.Zoom;
            pipeTop.SizeMode = PictureBoxSizeMode.StretchImage;
            pipeBottom.SizeMode = PictureBoxSizeMode.StretchImage;
        }

        private void InitializeUiAssets()
        {
            // Message overlay (Get Ready)
            if (overlayMessage == null)
            {
                overlayMessage = new PictureBox
                {
                    BackColor = Color.Transparent,
                    SizeMode = PictureBoxSizeMode.AutoSize,
                    Image = Resources.message
                };
                Controls.Add(overlayMessage);
                overlayMessage.BringToFront();
            }

            // Game over overlay
            if (overlayGameOver == null)
            {
                overlayGameOver = new PictureBox
                {
                    BackColor = Color.Transparent,
                    SizeMode = PictureBoxSizeMode.AutoSize,
                    Image = Resources.gameover,
                    Visible = false
                };
                Controls.Add(overlayGameOver);
                overlayGameOver.BringToFront();
            }

            PositionOverlays();
        }

        private void PositionOverlays()
        {
            if (overlayMessage != null)
            {
                overlayMessage.Left = (ClientSize.Width - overlayMessage.Width) / 2;
                overlayMessage.Top = 100;
            }
            if (overlayGameOver != null)
            {
                overlayGameOver.Left = (ClientSize.Width - overlayGameOver.Width) / 2;
                overlayGameOver.Top = 120;
            }
        }

        private void InitializeGame()
        {
            // Reset game objects
            score = 0;
            lblScore.Text = "Score: 0";
            isPaused = false;
            isFlapping = false;
            isGameOver = false;
            wingFrame = 0;
            animTick = 0;
            pipeSpeed = 5;

            // Place bird and reset sprite
            bird.Location = new Point(80, 220);
            bird.Image = birdFrameMid;

            // Choose pipe color
            SetPipeSprites(rng.Next(2) == 0 ? Resources.pipe_green : Resources.pipe_red);

            // Create an initial random gap position
            ApplyRandomGap(resetX: true);

            // Overlays
            if (overlayMessage != null) overlayMessage.Visible = true;
            if (overlayGameOver != null) overlayGameOver.Visible = false;
            lblInstructions.Visible = false; // use overlays instead of text

            gameTimer.Start();
        }

        private void SetPipeSprites(Bitmap bottomPipe)
        {
            // Dispose previous if exists to avoid leaks
            if (pipeSprite != null && !object.ReferenceEquals(pipeSprite, bottomPipe))
            {
                pipeSprite.Dispose();
            }
            if (pipeTopSprite != null)
            {
                pipeTopSprite.Dispose();
                pipeTopSprite = null;
            }

            // Assign bottom sprite
            pipeSprite = (Bitmap)bottomPipe.Clone();

            // Create vertically flipped sprite for top pipe
            pipeTopSprite = (Bitmap)pipeSprite.Clone();
            pipeTopSprite.RotateFlip(RotateFlipType.RotateNoneFlipY);

            // Apply to picture boxes
            pipeBottom.Image = pipeSprite;
            pipeTop.Image = pipeTopSprite;
        }

        private void ApplyRandomGap(bool resetX)
        {
            int gapSize = 140; // Distance between top and bottom pipe
            int minTopHeight = 60;
            int maxTopHeight = 300;
            int topHeight = rng.Next(minTopHeight, maxTopHeight);

            // Set verticals
            pipeTop.Height = topHeight;
            pipeTop.Top = -pipeTop.Height + 20; // start above the screen a bit

            pipeBottom.Top = pipeTop.Bottom + gapSize;
            pipeBottom.Height = ClientSize.Height - pipeBottom.Top - ground.Height;

            // Reset X to right edge if requested
            if (resetX)
            {
                int startX = ClientSize.Width + 100;
                pipeTop.Left = startX;
                pipeBottom.Left = startX;
            }
            else
            {
                // Also randomize pipe color sometimes when recycling
                if (rng.Next(4) == 0) // 25% chance to switch color theme
                {
                    SetPipeSprites(rng.Next(2) == 0 ? Resources.pipe_green : Resources.pipe_red);
                }
            }
        }

        private void gameTimer_Tick(object sender, EventArgs e)
        {
            if (isPaused || isGameOver) return;

            // Bird physics
            int velocityY = gravity;
            if (isFlapping)
            {
                velocityY += flapPower; // negative value to push up
                isFlapping = false;     // one-shot impulse on key press
            }
            bird.Top += velocityY;

            // Animate bird wings
            AnimateBird();

            // Move pipes
            pipeTop.Left -= pipeSpeed;
            pipeBottom.Left -= pipeSpeed;

            // Recycle pipes if they leave screen and increase score
            if (pipeTop.Right < 0)
            {
                ApplyRandomGap(resetX: true);
                score++;
                lblScore.Text = $"Score: {score}";
                SafePlay(sPoint);

                // Gradually increase difficulty
                if (score % 5 == 0)
                {
                    pipeSpeed = Math.Min(12, pipeSpeed + 1);
                }
            }

            // Collision detection
            if (CheckCollision())
            {
                GameOver();
                return;
            }
        }

        private void AnimateBird()
        {
            animTick++;
            if (animTick >= animIntervalTicks)
            {
                animTick = 0;
                wingFrame = (wingFrame + 1) % 3;
                switch (wingFrame)
                {
                    case 0: bird.Image = birdFrameDown; break;
                    case 1: bird.Image = birdFrameMid; break;
                    case 2: bird.Image = birdFrameUp; break;
                }
            }
        }

        private bool CheckCollision()
        {
            // Ground or ceiling
            if (bird.Bottom >= ground.Top || bird.Top <= 0)
                return true;

            // Pipes
            Rectangle birdRect = bird.Bounds;
            if (birdRect.IntersectsWith(pipeTop.Bounds) || birdRect.IntersectsWith(pipeBottom.Bounds))
                return true;

            return false;
        }

        private void GameOver()
        {
            isGameOver = true;
            gameTimer.Stop();
            if (overlayGameOver != null) overlayGameOver.Visible = true;
            if (overlayMessage != null) overlayMessage.Visible = false;
            SafePlay(sHit);
            SafePlay(sDie);
            // Keep label minimal
            lblInstructions.Visible = true;
            lblInstructions.Text = "Game Over! Press R to restart. Esc to pause.";
        }

        private void SafePlay(SoundPlayer sp)
        {
            try { sp?.Stop(); sp?.Play(); } catch { /* ignore */ }
        }

        private void Form1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Space)
            {
                if (!isPaused && !isGameOver)
                {
                    isFlapping = true;
                    if (overlayMessage != null && overlayMessage.Visible)
                        overlayMessage.Visible = false;
                    SafePlay(sWing);
                }
            }
            else if (e.KeyCode == Keys.R)
            {
                SafePlay(sSwoosh);
                InitializeGame();
            }
            else if (e.KeyCode == Keys.Escape)
            {
                isPaused = !isPaused;
                lblInstructions.Visible = true;
                lblInstructions.Text = isPaused ? "Paused. Esc to resume." : "Press Space to flap. Press R to restart. Esc to pause.";
            }
        }

        private void Form1_KeyUp(object sender, KeyEventArgs e)
        {
            // No continuous action needed on key up for this template
        }

        protected override void OnResize(EventArgs e)
        {
            base.OnResize(e);
            PositionOverlays();
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                pipeSprite?.Dispose();
                pipeTopSprite?.Dispose();
            }
            base.Dispose(disposing);
        }
    }
}
